<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå° - Noah Box</title>
    <link rel="stylesheet" href="code-editor-theme.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="logo">Noah Box</a>
                <nav class="nav">
                    <a href="/" class="nav-button">
                        ğŸ  home
                    </a>
                    <a href="/downloads.html" class="nav-button">
                        ğŸ“ downloads
                    </a>
                    <button class="nav-button" onclick="toggleTheme()">
                        ğŸŒ“ theme
                    </button>
                    <button class="nav-button" onclick="logout()">
                        ğŸšª logout
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">// ç®¡ç†é¢æ¿</div>
            </div>
            
            <ul class="sidebar-menu">
                <li>
                    <a href="#dashboard" class="sidebar-link active" onclick="showSection('dashboard')">
                        <span class="sidebar-icon">ğŸ“Š</span>
                        <span>ä»ªè¡¨æ¿</span>
                    </a>
                </li>
                <li>
                    <a href="#categories" class="sidebar-link" onclick="showSection('categories')">
                        <span class="sidebar-icon">ğŸ“‚</span>
                        <span>åˆ†ç±»ç®¡ç†</span>
                    </a>
                </li>
                <li>
                    <a href="#files" class="sidebar-link" onclick="showSection('files')">
                        <span class="sidebar-icon">ğŸ“</span>
                        <span>æ–‡ä»¶ç®¡ç†</span>
                    </a>
                </li>
                <li>
                    <a href="#upload" class="sidebar-link" onclick="showSection('upload')">
                        <span class="sidebar-icon">â¬†ï¸</span>
                        <span>æ–‡ä»¶ä¸Šä¼ </span>
                    </a>
                </li>
                <li>
                    <a href="#settings" class="sidebar-link" onclick="showSection('settings')">
                        <span class="sidebar-icon">âš™ï¸</span>
                        <span>ç³»ç»Ÿè®¾ç½®</span>
                    </a>
                </li>
            </ul>
        </aside>

        <main class="admin-content">
            <!-- ä»ªè¡¨æ¿ -->
            <section id="dashboard" class="content-section active">
                <div class="content-header">
                    <h1 class="content-title">// ä»ªè¡¨æ¿</h1>
                    <p class="content-description">ç³»ç»Ÿæ¦‚è§ˆå’Œå…³é”®æŒ‡æ ‡</p>
                </div>

                <div class="stats-grid" style="margin-bottom: 32px;">
                    <div class="stat-card">
                        <div class="stat-label">const totalFiles =</div>
                        <div class="stat-value" id="totalFiles">0</div>
                        <div class="stat-description">// æ€»æ–‡ä»¶æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">const categories =</div>
                        <div class="stat-value" id="totalCategories">0</div>
                        <div class="stat-description">// åˆ†ç±»æ•°é‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">const todayDownloads =</div>
                        <div class="stat-value" id="todayDownloads">0</div>
                        <div class="stat-description">// ä»Šæ—¥ä¸‹è½½</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">const activeUsers =</div>
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-description">// æ´»è·ƒç”¨æˆ·</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">// ç³»ç»ŸçŠ¶æ€</h3>
                        <p class="card-description">å®æ—¶ç³»ç»Ÿå¥åº·çŠ¶å†µç›‘æ§</p>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="color: var(--success); font-size: 16px;">âœ…</span>
                            <div>
                                <div style="font-weight: 500; color: var(--text-primary);">ç³»ç»Ÿè¿è¡Œ</div>
                                <div style="font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">// status: online</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="color: var(--success); font-size: 16px;">âœ…</span>
                            <div>
                                <div style="font-weight: 500; color: var(--text-primary);">æ•°æ®åº“</div>
                                <div style="font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">// connection: ok</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="color: var(--success); font-size: 16px;">âœ…</span>
                            <div>
                                <div style="font-weight: 500; color: var(--text-primary);">å­˜å‚¨ç©ºé—´</div>
                                <div style="font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">// space: available</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="color: var(--warning); font-size: 16px;">âš ï¸</span>
                            <div>
                                <div style="font-weight: 500; color: var(--text-primary);">å¤‡ä»½çŠ¶æ€</div>
                                <div style="font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">// last: 3 days ago</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- åˆ†ç±»ç®¡ç† -->
            <section id="categories" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">// åˆ†ç±»ç®¡ç†</h1>
                    <p class="content-description">ç®¡ç†æ–‡ä»¶åˆ†ç±»å’Œæ ‡ç­¾</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">// æ·»åŠ æ–°åˆ†ç±»</h3>
                        <p class="card-description">åˆ›å»ºæ–°çš„æ–‡ä»¶åˆ†ç±»</p>
                    </div>
                    
                    <form id="categoryForm" style="max-width: 400px;">
                        <div class="form-group">
                            <label class="form-label">// åˆ†ç±»åç§°</label>
                            <input type="text" class="form-input" id="categoryName" placeholder="è¾“å…¥åˆ†ç±»åç§°" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">// åˆ†ç±»æè¿°</label>
                            <input type="text" class="form-input" id="categoryDescription" placeholder="è¾“å…¥åˆ†ç±»æè¿°">
                        </div>
                        <div class="form-group">
                            <label class="form-label">// åˆ†ç±»å›¾æ ‡</label>
                            <select class="form-input" id="categoryIcon">
                                <option value="ğŸ“„">ğŸ“„ æ–‡æ¡£</option>
                                <option value="ğŸ–¼ï¸">ğŸ–¼ï¸ å›¾ç‰‡</option>
                                <option value="ğŸ¬">ğŸ¬ è§†é¢‘</option>
                                <option value="ğŸµ">ğŸµ éŸ³é¢‘</option>
                                <option value="ğŸ“¦">ğŸ“¦ å‹ç¼©åŒ…</option>
                                <option value="ğŸ’»">ğŸ’» ä»£ç </option>
                                <option value="ğŸ“Š">ğŸ“Š æ•°æ®</option>
                                <option value="ğŸ”§">ğŸ”§ å·¥å…·</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            â• addCategory()
                        </button>
                    </form>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">// ç°æœ‰åˆ†ç±»</h3>
                        <button class="btn btn-secondary" onclick="loadCategories()">ğŸ”„ refresh</button>
                    </div>
                    
                    <div id="categoriesContainer">
                        <div class="message">æ­£åœ¨åŠ è½½åˆ†ç±»åˆ—è¡¨...</div>
                    </div>
                </div>
            </section>

            <!-- æ–‡ä»¶ç®¡ç† -->
            <section id="files" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">// æ–‡ä»¶ç®¡ç†</h1>
                    <p class="content-description">ç®¡ç†å’Œç»„ç»‡æ‚¨çš„æ–‡ä»¶èµ„æº</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">// æ–‡ä»¶åˆ—è¡¨</h3>
                        <div style="display: flex; gap: 12px;">
                            <select class="form-input" id="categoryFilter" style="width: 200px;" onchange="filterFilesByCategory()">
                                <option value="">// æ‰€æœ‰åˆ†ç±»</option>
                            </select>
                            <button class="btn btn-secondary" onclick="loadFiles()">ğŸ”„ refresh</button>
                            <button class="btn btn-primary" onclick="showSection('upload')">â¬†ï¸ upload</button>
                        </div>
                    </div>
                    
                    <div id="fileTableContainer">
                        <div class="message">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>
                    </div>
                </div>
            </section>

            <!-- æ–‡ä»¶ä¸Šä¼  -->
            <section id="upload" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">// æ–‡ä»¶ä¸Šä¼ </h1>
                    <p class="content-description">ä¸Šä¼ æ–°æ–‡ä»¶åˆ°ç³»ç»Ÿ</p>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label class="form-label">// é€‰æ‹©åˆ†ç±»</label>
                        <select class="form-input" id="uploadCategory" style="max-width: 300px;">
                            <option value="">é€‰æ‹©æ–‡ä»¶åˆ†ç±»</option>
                        </select>
                    </div>
                    
                    <div style="border: 2px dashed var(--border); border-radius: 4px; padding: 48px 24px; text-align: center; background: var(--bg-tertiary); transition: all 0.3s; cursor: pointer;" id="uploadZone">
                        <div style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;">ğŸ“</div>
                        <div style="font-size: 16px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;">
                            æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©
                        </div>
                        <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 24px;">
                            // æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œæœ€å¤§å•æ–‡ä»¶ 100MB
                        </div>
                        <input type="file" id="fileInput" multiple style="display: none;">
                        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            ğŸ“‚ selectFiles()
                        </button>
                    </div>
                    
                    <div id="uploadProgress" style="display: none; margin-top: 24px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-family: 'JetBrains Mono', monospace; font-size: 13px;">// ä¸Šä¼ è¿›åº¦</span>
                            <span id="progressText" style="font-family: 'JetBrains Mono', monospace; font-size: 13px;">0%</span>
                        </div>
                        <div style="width: 100%; height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden;">
                            <div id="progressFill" style="height: 100%; background: linear-gradient(90deg, var(--code-keyword), var(--code-string)); border-radius: 3px; transition: width 0.3s ease; width: 0%;"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ç³»ç»Ÿè®¾ç½® -->
            <section id="settings" class="content-section">
                <div class="content-header">
                    <h1 class="content-title">// ç³»ç»Ÿè®¾ç½®</h1>
                    <p class="content-description">é…ç½®ç³»ç»Ÿå‚æ•°å’Œå®‰å…¨è®¾ç½®</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">// å®‰å…¨è®¾ç½®</h3>
                        <p class="card-description">ä¿®æ”¹ç®¡ç†å‘˜å¯†ç å’Œå®‰å…¨é…ç½®</p>
                    </div>
                    
                    <form id="passwordForm" style="max-width: 400px;">
                        <div class="form-group">
                            <label class="form-label">// å½“å‰å¯†ç </label>
                            <input type="password" class="form-input" id="currentPassword" placeholder="è¯·è¾“å…¥å½“å‰å¯†ç " required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">// æ–°å¯†ç </label>
                            <input type="password" class="form-input" id="newPassword" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">// ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" class="form-input" id="confirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç " required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            ğŸ” updatePassword()
                        </button>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let sessionId = null;
        let categories = [];
        let allFiles = [];

        // è·å–session ID
        function getSessionId() {
            if (sessionId) return sessionId;
            
            // ä»localStorageè·å–
            sessionId = localStorage.getItem('sessionId');
            return sessionId;
        }

        // è®¾ç½®session ID
        function setSessionId(id) {
            sessionId = id;
            localStorage.setItem('sessionId', id);
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(url, options = {}) {
            const sid = getSessionId();
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (sid) {
                headers['X-Session-ID'] = sid;
            }

            const response = await fetch(url, {
                ...options,
                headers
            });

            if (response.status === 401) {
                // æœªæˆæƒï¼Œæ¸…é™¤sessionå¹¶è·³è½¬ç™»å½•
                localStorage.removeItem('sessionId');
                sessionId = null;
                window.location.href = '/login.html';
                return null;
            }

            return response;
        }

        function toggleTheme() {
            console.log('Theme toggle clicked');
        }

        function showSection(sectionId) {
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰èœå•é¡¹çš„activeç±»
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // æ˜¾ç¤ºæŒ‡å®šéƒ¨åˆ†
            document.getElementById(sectionId).classList.add('active');
            
            // æ·»åŠ activeç±»åˆ°å¯¹åº”èœå•é¡¹
            document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');
            
            // æ ¹æ®éƒ¨åˆ†åŠ è½½ç›¸åº”æ•°æ®
            if (sectionId === 'files') {
                loadFiles();
            } else if (sectionId === 'dashboard') {
                loadDashboard();
            } else if (sectionId === 'categories') {
                loadCategories();
            } else if (sectionId === 'upload') {
                loadCategoriesForUpload();
            }
        }

        async function loadDashboard() {
            try {
                const response = await apiRequest('/api/stats');
                if (response && response.ok) {
                    const stats = await response.json();
                    document.getElementById('totalFiles').textContent = stats.totalFiles || 0;
                    document.getElementById('totalCategories').textContent = stats.totalCategories || 0;
                    document.getElementById('todayDownloads').textContent = stats.todayDownloads || 0;
                    document.getElementById('activeUsers').textContent = stats.activeUsers || 0;
                } else {
                    // æ˜¾ç¤ºç¤ºä¾‹æ•°æ®
                    document.getElementById('totalFiles').textContent = '24';
                    document.getElementById('totalCategories').textContent = '6';
                    document.getElementById('todayDownloads').textContent = '18';
                    document.getElementById('activeUsers').textContent = '5';
                }
            } catch (error) {
                console.error('åŠ è½½ä»ªè¡¨ç›˜æ•°æ®å¤±è´¥:', error);
                // æ˜¾ç¤ºç¤ºä¾‹æ•°æ®
                document.getElementById('totalFiles').textContent = '24';
                document.getElementById('totalCategories').textContent = '6';
                document.getElementById('todayDownloads').textContent = '18';
                document.getElementById('activeUsers').textContent = '5';
            }
        }

        async function loadCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '<div class="message">æ­£åœ¨åŠ è½½åˆ†ç±»åˆ—è¡¨...</div>';

            try {
                const response = await apiRequest('/api/categories');
                if (response && response.ok) {
                    const data = await response.json();
                    categories = data.categories || [];
                } else {
                    // ä½¿ç”¨ç¤ºä¾‹åˆ†ç±»
                    categories = [
                        { id: 1, name: 'æ–‡æ¡£', description: 'å„ç±»æ–‡æ¡£æ–‡ä»¶', icon: 'ğŸ“„', count: 8 },
                        { id: 2, name: 'å›¾ç‰‡', description: 'å›¾ç‰‡å’Œå›¾åƒæ–‡ä»¶', icon: 'ğŸ–¼ï¸', count: 12 },
                        { id: 3, name: 'è§†é¢‘', description: 'è§†é¢‘æ–‡ä»¶', icon: 'ğŸ¬', count: 3 },
                        { id: 4, name: 'ä»£ç ', description: 'æºä»£ç æ–‡ä»¶', icon: 'ğŸ’»', count: 15 },
                        { id: 5, name: 'å·¥å…·', description: 'å®ç”¨å·¥å…·è½¯ä»¶', icon: 'ğŸ”§', count: 6 },
                        { id: 6, name: 'å…¶ä»–', description: 'å…¶ä»–ç±»å‹æ–‡ä»¶', icon: 'ğŸ“¦', count: 4 }
                    ];
                }

                renderCategories();
                updateCategoryFilters();
            } catch (error) {
                console.error('åŠ è½½åˆ†ç±»å¤±è´¥:', error);
                container.innerHTML = '<div class="message error">// Error: åŠ è½½åˆ†ç±»å¤±è´¥</div>';
            }
        }

        function renderCategories() {
            const container = document.getElementById('categoriesContainer');
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‚</div>
                        <h3>// æš‚æ— åˆ†ç±»</h3>
                        <p>è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•åˆ†ç±»</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                    ${categories.map(category => `
                        <div class="card" style="padding: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                <span style="font-size: 24px;">${category.icon}</span>
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${escapeHtml(category.name)}</div>
                                    <div style="font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">// ${category.count || 0} files</div>
                                </div>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                                ${escapeHtml(category.description || '')}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px;" onclick="editCategory(${category.id})">
                                    âœï¸ edit
                                </button>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; color: var(--error);" onclick="deleteCategory(${category.id})">
                                    ğŸ—‘ï¸ delete
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function updateCategoryFilters() {
            const categoryFilter = document.getElementById('categoryFilter');
            const uploadCategory = document.getElementById('uploadCategory');
            
            if (categoryFilter) {
                categoryFilter.innerHTML = '<option value="">// æ‰€æœ‰åˆ†ç±»</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('');
            }
            
            if (uploadCategory) {
                uploadCategory.innerHTML = '<option value="">é€‰æ‹©æ–‡ä»¶åˆ†ç±»</option>' +
                    categories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('');
            }
        }

        async function loadCategoriesForUpload() {
            if (categories.length === 0) {
                await loadCategories();
            }
            updateCategoryFilters();
        }

        async function loadFiles() {
            const container = document.getElementById('fileTableContainer');
            container.innerHTML = '<div class="message">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</div>';

            try {
                const response = await apiRequest('/api/admin/files');
                if (response && response.ok) {
                    const data = await response.json();
                    allFiles = data.files || [];
                } else {
                    // ä½¿ç”¨ç¤ºä¾‹æ–‡ä»¶
                    allFiles = [
                        { id: 1, name: 'README.md', size: '2.5 KB', modified: '2024-01-15', category: 'æ–‡æ¡£', categoryId: 1 },
                        { id: 2, name: 'config.json', size: '1.2 KB', modified: '2024-01-14', category: 'ä»£ç ', categoryId: 4 },
                        { id: 3, name: 'app.js', size: '15.8 KB', modified: '2024-01-13', category: 'ä»£ç ', categoryId: 4 },
                        { id: 4, name: 'screenshot.png', size: '245 KB', modified: '2024-01-12', category: 'å›¾ç‰‡', categoryId: 2 },
                        { id: 5, name: 'demo.mp4', size: '12.5 MB', modified: '2024-01-11', category: 'è§†é¢‘', categoryId: 3 },
                        { id: 6, name: 'tool.exe', size: '8.9 MB', modified: '2024-01-10', category: 'å·¥å…·', categoryId: 5 }
                    ];
                }

                renderFiles();
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
                container.innerHTML = '<div class="message error">// Error: åŠ è½½æ–‡ä»¶å¤±è´¥</div>';
            }
        }

        function renderFiles(filesToRender = null) {
            const container = document.getElementById('fileTableContainer');
            const files = filesToRender || allFiles;
            
            if (files.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <h3>// æš‚æ— æ–‡ä»¶</h3>
                        <p>è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•æ–‡ä»¶</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div style="background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 4px; overflow: hidden;">
                    <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; color: var(--text-primary);">
                        // æ–‡ä»¶åˆ—è¡¨ (${files.length} ä¸ªæ–‡ä»¶)
                    </div>
                    ${files.map(file => `
                        <div style="display: grid; grid-template-columns: 1fr auto auto auto; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); transition: all 0.2s;">
                            <div>
                                <div style="font-family: 'JetBrains Mono', monospace; font-weight: 500; color: var(--text-primary); margin-bottom: 4px;">${escapeHtml(file.name)}</div>
                                <div style="font-size: 11px; color: var(--text-muted); font-family: 'JetBrains Mono', monospace;">
                                    ${file.size} â€¢ ${file.category || 'æœªåˆ†ç±»'} â€¢ ${file.modified}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px;" onclick="downloadFile('${escapeHtml(file.name)}')" title="ä¸‹è½½">
                                    â¬‡ï¸
                                </button>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px;" onclick="editFile(${file.id})" title="ç¼–è¾‘">
                                    âœï¸
                                </button>
                                <button class="btn btn-secondary" style="padding: 6px 12px; font-size: 11px; color: var(--error);" onclick="deleteFile('${escapeHtml(file.name)}')" title="åˆ é™¤">
                                    ğŸ—‘ï¸
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function filterFilesByCategory() {
            const categoryId = document.getElementById('categoryFilter').value;
            if (!categoryId) {
                renderFiles();
                return;
            }
            
            const filteredFiles = allFiles.filter(file => file.categoryId == categoryId);
            renderFiles(filteredFiles);
        }

        // åˆ†ç±»ç®¡ç†åŠŸèƒ½
        function setupCategoryForm() {
            document.getElementById('categoryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('categoryName').value;
                const description = document.getElementById('categoryDescription').value;
                const icon = document.getElementById('categoryIcon').value;

                try {
                    const response = await apiRequest('/api/categories', {
                        method: 'POST',
                        body: JSON.stringify({ name, description, icon })
                    });

                    if (response && response.ok) {
                        showMessage('åˆ†ç±»åˆ›å»ºæˆåŠŸï¼', 'success');
                        document.getElementById('categoryForm').reset();
                        loadCategories();
                    } else {
                        showMessage('åˆ†ç±»åˆ›å»ºå¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('åˆ›å»ºåˆ†ç±»å¤±è´¥:', error);
                    showMessage('åˆ†ç±»åˆ›å»ºå¤±è´¥', 'error');
                }
            });
        }

        function editCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            const newName = prompt('ä¿®æ”¹åˆ†ç±»åç§°:', category.name);
            if (newName && newName !== category.name) {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨APIæ›´æ–°åˆ†ç±»
                showMessage('åˆ†ç±»æ›´æ–°æˆåŠŸï¼', 'success');
                loadCategories();
            }
        }

        async function deleteCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            if (!category) return;

            if (!confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±» "${category.name}" å—ï¼Ÿ`)) return;

            try {
                const response = await apiRequest(`/api/categories/${categoryId}`, {
                    method: 'DELETE'
                });

                if (response && response.ok) {
                    showMessage('åˆ†ç±»åˆ é™¤æˆåŠŸï¼', 'success');
                    loadCategories();
                } else {
                    showMessage('åˆ†ç±»åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤åˆ†ç±»å¤±è´¥:', error);
                showMessage('åˆ†ç±»åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
        function setupFileUpload() {
            const uploadZone = document.getElementById('uploadZone');
            const fileInput = document.getElementById('fileInput');

            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--code-keyword)';
                uploadZone.style.background = 'var(--bg-primary)';
            });

            uploadZone.addEventListener('dragleave', () => {
                uploadZone.style.borderColor = 'var(--border)';
                uploadZone.style.background = 'var(--bg-tertiary)';
            });

            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.style.borderColor = 'var(--border)';
                uploadZone.style.background = 'var(--bg-tertiary)';
                uploadFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => {
                uploadFiles(e.target.files);
            });
        }

        async function uploadFiles(files) {
            if (files.length === 0) return;

            const categoryId = document.getElementById('uploadCategory').value;
            if (!categoryId) {
                showMessage('è¯·å…ˆé€‰æ‹©æ–‡ä»¶åˆ†ç±»', 'warning');
                return;
            }

            const progressContainer = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressContainer.style.display = 'block';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('categoryId', categoryId);

                try {
                    const response = await apiRequest('/api/admin/upload', {
                        method: 'POST',
                        body: formData,
                        headers: {} // ä¸è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
                    });

                    const progress = Math.round(((i + 1) / files.length) * 100);
                    progressFill.style.width = progress + '%';
                    progressText.textContent = progress + '%';

                    if (!response || !response.ok) {
                        console.error(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥`);
                    }
                } catch (error) {
                    console.error(`æ–‡ä»¶ ${file.name} ä¸Šä¼ å¤±è´¥:`, error);
                }
            }

            setTimeout(() => {
                progressContainer.style.display = 'none';
                progressFill.style.width = '0%';
                progressText.textContent = '0%';
                
                showMessage('æ–‡ä»¶ä¸Šä¼ å®Œæˆï¼', 'success');
                
                if (document.getElementById('files').classList.contains('active')) {
                    loadFiles();
                }
            }, 1000);
        }

        function downloadFile(filename) {
            const link = document.createElement('a');
            link.href = `/api/download/${encodeURIComponent(filename)}`;
            link.download = filename;
            link.click();
        }

        function editFile(fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            // è¿™é‡Œå¯ä»¥å®ç°æ–‡ä»¶ç¼–è¾‘åŠŸèƒ½
            showMessage('æ–‡ä»¶ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­', 'warning');
        }

        async function deleteFile(filename) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) return;
            
            try {
                const response = await apiRequest(`/api/admin/files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });

                if (response && response.ok) {
                    showMessage('æ–‡ä»¶åˆ é™¤æˆåŠŸï¼', 'success');
                    loadFiles();
                } else {
                    showMessage('æ–‡ä»¶åˆ é™¤å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                showMessage('æ–‡ä»¶åˆ é™¤å¤±è´¥', 'error');
            }
        }

        function setupPasswordForm() {
            document.getElementById('passwordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    showMessage('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…', 'error');
                    return;
                }

                if (newPassword.length < 6) {
                    showMessage('æ–°å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦', 'error');
                    return;
                }

                try {
                    const response = await apiRequest('/api/change-password', {
                        method: 'POST',
                        body: JSON.stringify({ currentPassword, newPassword })
                    });

                    if (response && response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            showMessage('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•', 'success');
                            setTimeout(() => logout(), 2000);
                        } else {
                            showMessage(result.message || 'å¯†ç ä¿®æ”¹å¤±è´¥', 'error');
                        }
                    } else {
                        showMessage('å¯†ç ä¿®æ”¹å¤±è´¥', 'error');
                    }
                } catch (error) {
                    console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                    showMessage('ä¿®æ”¹å¯†ç å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            });
        }

        function showMessage(text, type = 'success') {
            const message = document.createElement('div');
            message.className = `message ${type}`;
            message.textContent = `// ${text}`;
            
            // æ‰¾åˆ°å½“å‰æ´»è·ƒçš„section
            const activeSection = document.querySelector('.content-section.active');
            if (activeSection) {
                activeSection.appendChild(message);
                setTimeout(() => message.remove(), 3000);
            }
        }

        async function logout() {
            try {
                await apiRequest('/api/logout', { method: 'POST' });
            } catch (error) {
                console.error('ç™»å‡ºå¤±è´¥:', error);
            }
            
            localStorage.removeItem('sessionId');
            sessionId = null;
            window.location.href = '/login.html';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkAuth() {
            try {
                const response = await apiRequest('/api/auth/status');
                if (!response || !response.ok) {
                    window.location.href = '/login.html';
                    return false;
                }
                
                const data = await response.json();
                if (!data.authenticated) {
                    window.location.href = '/login.html';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                if (location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    window.location.href = '/login.html';
                }
                return false;
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) return;
            
            setupFileUpload();
            setupPasswordForm();
            setupCategoryForm();
            loadDashboard();
            loadCategories();
        });
    </script>
</body>
</html>